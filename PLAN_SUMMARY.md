# ?? ИСПРАВЛЕННЫЙ И ФИНАЛЬНЫЙ ПЛАН (Quick Start)

## Статус: ? ГОТОВ К РЕАЛИЗАЦИИ

---

## ?? Что меняется (кратко)

### Структура данных
- ? **Новый класс:** `OrderFileItem.cs` — один файл в заказе
- ? **Расширенный:** `OrderData.cs` — добавляем `List<OrderFileItem> Items`
- ? **Расширенный:** `AppSettings.cs` — новые параметры (MaxParallelism, VariantDictionary, и т.д.)

### UI
- ?? Таблица `gridOrders` переходит на **иерархическое отображение** (заказ ? Items)
- ?? Drag-and-drop теперь добавляет/перемещает Items внутри заказа
- ?? Кнопка expand/collapse для открытия/закрытия Items в заказе

### Обработка
- ?? `OrderProcessor.RunAsync()` — обработка списка Items (последовательно или параллельно)
- ?? Агрегированный статус: заказ показывает прогресс (? Частично готово X/Y)
- ? Параллельная обработка Files с ограничением (`MaxParallelism`)

---

## ?? График реализации

| Этап | Время | Что делать | Сложность |
|------|-------|-----------|----------|
| **1. Data** | 1-2ч | Создать классы, расширить настройки, миграция JSON | ?? Легко |
| **2. UI иерархии** | 6-8ч | Переписать отображение таблицы, expand/collapse | ?? Сложно |
| **3. Pipeline** | 6-8ч | Переписать обработку Items, параллелизм, диалоги | ?? Сложно |
| **4. Оптимизация** | 2-3ч | Вспомогательные функции, тесты | ?? Опционально |
| **ИТОГО** | **~13-18ч** | **Полная многофайловая система** | ? |

---

## ?? Порядок действий

### Фаза 1: Инфраструктура (1-2 часа)
1. ? Создать `OrderFileItem.cs`
2. ? Обновить `OrderData.cs` (добавить `Items`)
3. ? Обновить `AppSettings.cs` (новые параметры)
4. ? Встроить миграцию в `Form1.LoadHistory()`
5. ? Добавить `RefreshAggregatedStatus()` в `OrderData.cs`
6. **Компилируем ? работает со старыми заказами как раньше**

### Фаза 2: UI (6-8 часов)
1. ? Добавить метод `RefreshGridWithHierarchy()` в Form1
   - Перестраивает строки таблицы с учётом Items
   - Items отображаются со смещением (визуально под заказом)
   - Кнопка expand/collapse скрывает/показывает Items
2. ? Обновить drag-and-drop логику
   - Если пользователь тащит на Item ? обновляет его
   - Если тащит ниже всех Items ? создаёт новый Item
3. ? Добавить контекстное меню для Items
   - Удалить, копировать, переместить выше/ниже
4. ? Меню «Превратить в группу» для однофайловых заказов

### Фаза 3: Обработка (6-8 часов)
1. ? Переписать `OrderProcessor.RunAsync()`:
   - Если `Items.Count > 0` ? обработка Items
   - Иначе ? fallback на старую логику
2. ? Параллельная обработка с простым ограничением
   - Батчи по `MaxParallelism` файлов
   - `Task.WhenAll()` для параллелизма
3. ? Обновление UI прогресса
   - Обновление статуса Item-а при обработке
   - Статус-бар показывает Обработано X/Y
4. ? Диалог выбора режима (встроить в контекстное меню)

### Фаза 4: Polish (опционально, 2-3 часа)
- Вспомогательные функции (автопереименование, валидация)
- Оптимизация UI для больших заказов
- Базовые тесты

---

## ?? Ключевые принципы

1. **Обратная совместимость** ??
   - Старые заказы без Items работают как раньше
   - При первом открытии 1 Item автоматически создаётся из старых полей
   - Сохранение синхронизирует Items[0] ? старые поля

2. **Простота UI** ??
   - Не менять структуру `DataGridView`
   - Items показывать как обычные строки со смещением
   - Expand/collapse через простое скрытие/отображение строк

3. **Минимум сложности** ?
   - Без `SemaphoreSlim`, без `TreeView`, без лишних диалогов
   - Параллелизм = батчи + `Task.WhenAll()`
   - Диалоги встроить в контекстное меню

---

## ? Контрольный список

- [ ] Этап 1 завершён и компилируется
- [ ] Заказы загружаются/сохраняются с Items
- [ ] Миграция старых заказов работает
- [ ] Этап 2 завершён и UI отображает Items
- [ ] Drag-and-drop добавляет Items
- [ ] Этап 3 завершён и Items обрабатываются
- [ ] Статус заказа автоматически обновляется
- [ ] Параллельная обработка работает
- [ ] Приложение стабильно на 50+ файлах в одном заказе
- [ ] Есть базовые тесты

---

## ?? MVP Готов!

Полная многофайловая система в **13-18 часов**.
Никаких излишеств, всё работает с существующей архитектурой.
